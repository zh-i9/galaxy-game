<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>星际战机: 赛博进化</title>
    <!-- 引入科幻字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- 核心布局与美学 --- */
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-yellow: #ffe600;
            --bg-dark: #050b14;
            --glass: rgba(10, 20, 40, 0.75);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; }
        
        body { 
            background: #000; 
            height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            font-family: 'Orbitron', sans-serif; 
            overflow: hidden;
            /* 网页背景纹理 */
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000 100%);
        }

        /* 手机仿真容器 */
        #gameContainer {
            position: relative;
            width: 100%; max-width: 480px; height: 100%; max-height: 920px;
            background: var(--bg-dark);
            box-shadow: 0 0 60px rgba(0, 243, 255, 0.15);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI 层 --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 5;
        }

        .hud-row { display: flex; justify-content: space-between; align-items: center; text-shadow: 0 0 5px var(--neon-blue); }
        .score { font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 1px; }
        .level-badge { background: var(--neon-purple); padding: 2px 10px; border-radius: 4px; font-size: 12px; color: #fff; box-shadow: 0 0 10px var(--neon-purple); }

        .bottom-hud { margin-bottom: 10px; }
        .coin-box { font-size: 18px; color: var(--neon-yellow); margin-bottom: 8px; text-shadow: 0 0 5px var(--neon-yellow); display: flex; align-items: center; gap: 5px; }
        
        .hp-frame {
            width: 100%; height: 10px; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3); skew: -15deg; transform: skewX(-15deg);
            border-radius: 2px; overflow: hidden;
        }
        .hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff3333, #ff0055); transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- 弹窗系统 --- */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 10, 0.85); backdrop-filter: blur(12px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; opacity: 1; transition: opacity 0.4s;
        }
        .hidden { opacity: 0; pointer-events: none; }

        /* 标题动画 */
        .main-title {
            font-size: 42px; font-weight: 900; text-align: center;
            background: linear-gradient(to bottom, #fff, var(--neon-blue));
            -webkit-background-clip: text; color: transparent;
            margin-bottom: 10px; filter: drop-shadow(0 0 15px var(--neon-blue));
        }
        
        .subtitle { color: #8899ac; font-size: 14px; margin-bottom: 40px; letter-spacing: 2px; text-transform: uppercase; }

        /* 按钮样式 */
        .cyber-btn {
            background: transparent; color: var(--neon-blue);
            border: 2px solid var(--neon-blue); padding: 15px 50px;
            font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: bold;
            text-transform: uppercase; letter-spacing: 2px; cursor: pointer;
            position: relative; overflow: hidden; transition: 0.3s;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }
        .cyber-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: var(--neon-blue); transition: 0.3s; z-index: -1;
        }
        .cyber-btn:hover { color: #000; box-shadow: 0 0 30px var(--neon-blue); }
        .cyber-btn:hover::before { left: 0; }
        .cyber-btn:active { transform: scale(0.95); }

        /* 商店样式 */
        .shop-header { text-align: center; margin-bottom: 20px; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 90%; }
        
        .card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;
            text-align: center; transition: 0.2s; cursor: pointer; position: relative;
        }
        .card:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        .card.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        
        .card h3 { font-size: 14px; color: #fff; margin-bottom: 5px; }
        .card p { font-size: 10px; color: #aaa; margin-bottom: 8px; }
        .price-tag { color: var(--neon-yellow); font-weight: bold; font-size: 14px; text-shadow: 0 0 5px rgba(255, 230, 0, 0.5); }

        /* 进化提示 */
        .toast {
            position: absolute; top: 15%; width: 100%; text-align: center;
            font-size: 20px; font-weight: bold; color: var(--neon-yellow);
            text-shadow: 0 0 10px var(--neon-yellow);
            transform: translateY(-20px); opacity: 0; transition: 0.5s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>

    <div id="hud" class="ui-layer" style="display:none;">
        <div class="hud-row">
            <div class="score" id="uiScore">0000</div>
            <div class="level-badge">ZONE <span id="uiLevel">1</span></div>
        </div>
        <div class="bottom-hud">
            <div class="coin-box">⚡ <span id="uiCoins">0</span></div>
            <div class="hp-frame"><div class="hp-bar" id="uiHp"></div></div>
        </div>
        <div id="evoToast" class="toast">⚠️ 机体进化: 强袭模式</div>
    </div>

    <!-- 开始界面 -->
    <div id="startScreen" class="modal">
        <h1 class="main-title">CYBER<br>WING</h1>
        <p class="subtitle">// 滑动控制 • 自动射击 //</p>
        <button class="cyber-btn" onclick="game.start()">INITIATE</button>
    </div>

    <!-- 商店界面 -->
    <div id="shopScreen" class="modal hidden">
        <div class="shop-header">
            <h2 style="color:white; margin-bottom:5px">WAVE CLEARED</h2>
            <p style="color:var(--neon-yellow)">CREDITS: <span id="shopCoins">0</span></p>
        </div>
        <div class="shop-grid">
            <div class="card" onclick="game.upgrade('dmg')" id="btn-dmg">
                <h3 style="color:var(--neon-blue)">火力核心</h3>
                <p>伤害 +25%</p>
                <div class="price-tag">⚡ <span id="p-dmg">100</span></div>
            </div>
            <div class="card" onclick="game.upgrade('rate')" id="btn-rate">
                <h3 style="color:#ff0055">冷却压缩</h3>
                <p>射速 +15%</p>
                <div class="price-tag">⚡ <span id="p-rate">150</span></div>
            </div>
            <div class="card" onclick="game.upgrade('multi')" id="btn-multi">
                <h3 style="color:var(--neon-purple)">僚机扩容</h3>
                <p>弹道 +1</p>
                <div class="price-tag">⚡ <span id="p-multi">500</span></div>
            </div>
            <div class="card" onclick="game.upgrade('heal')" id="btn-heal">
                <h3 style="color:#0f0">纳米修复</h3>
                <p>恢复 100% HP</p>
                <div class="price-tag">⚡ 50</div>
            </div>
        </div>
        <button class="cyber-btn" style="margin-top:30px; transform:scale(0.8)" onclick="game.nextLevel()">NEXT ZONE</button>
    </div>

    <!-- 结算界面 -->
    <div id="overScreen" class="modal hidden">
        <h1 style="color:#ff0055; font-size:36px; text-shadow:0 0 20px #f00; margin-bottom:10px">CRITICAL ERROR</h1>
        <p style="color:white; margin-bottom:30px">FINAL SCORE: <span id="finalScore" style="color:var(--neon-blue)">0</span></p>
        <button class="cyber-btn" onclick="game.restart()">REBOOT</button>
    </div>
</div>

<script>
class Game {
    constructor() {
        this.c = document.getElementById('gameCanvas');
        this.ctx = this.c.getContext('2d');
        this.container = document.getElementById('gameContainer');
        
        // 自适应
        this.resize();
        window.onresize = () => this.resize();

        // 核心数据
        this.state = 'MENU'; 
        this.frame = 0;
        
        // 初始数值 (易上手调整)
        this.base = {
            dmg: 15, // 初始伤害提高
            hp: 100,
            rate: 25,
            speed: 1
        };
        
        this.stars = Array(60).fill().map(() => this.newStar());
        this.gridOffset = 0;
        
        this.bindInput();
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    resize() {
        this.w = this.container.clientWidth;
        this.h = this.container.clientHeight;
        this.c.width = this.w;
        this.c.height = this.h;
    }

    newStar() {
        return {
            x: Math.random() * this.w,
            y: Math.random() * this.h,
            z: Math.random() * 1.5 + 0.5, // 深度/速度
            alpha: Math.random()
        };
    }

    bindInput() {
        const move = (x, y) => {
            if (this.state !== 'PLAY') return;
            const rect = this.c.getBoundingClientRect();
            this.player.x = x - rect.left;
            this.player.y = Math.max(this.h * 0.4, Math.min(this.h - 40, y - rect.top - 40));
        };
        
        this.c.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        this.c.addEventListener('touchmove', e => {
            e.preventDefault();
            move(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});
    }

    // --- 游戏流程 ---

    start() {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('hud').style.display = 'flex';
        this.resetGame();
        this.state = 'PLAY';
    }

    resetGame() {
        this.player = {
            x: this.w/2, y: this.h - 100,
            hp: this.base.hp, maxHp: this.base.hp,
            dmg: this.base.dmg,
            rate: this.base.rate,
            bullets: 1,
            skin: 0 
        };
        
        this.level = 1;
        this.score = 0;
        this.coins = 50; // 初始送50块
        this.prices = { dmg: 100, rate: 150, multi: 500 };
        
        this.objs = { bullets: [], enemies: [], particles: [], texts: [] };
        this.levelProgress = 0;
        this.levelGoal = 15;
        
        this.updateUI();
    }

    nextLevel() {
        document.getElementById('shopScreen').classList.add('hidden');
        this.level++;
        this.levelProgress = 0;
        this.levelGoal = 10 + this.level * 8;
        this.player.hp = this.player.maxHp; // 免费回满血
        this.objs.bullets = [];
        this.objs.enemies = [];
        
        // 进化检测
        if (this.level === 3 || this.level === 6) {
            this.player.skin = this.level === 3 ? 1 : 2;
            this.showToast(this.player.skin === 1 ? "机体进化: 强袭模式" : "机体进化: 终极战神");
        }
        
        this.state = 'PLAY';
        this.updateUI();
    }

    restart() {
        document.getElementById('overScreen').classList.add('hidden');
        this.resetGame();
        this.state = 'PLAY';
    }

    showToast(msg) {
        const t = document.getElementById('evoToast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    // --- 逻辑更新 ---

    update() {
        // 背景网格滚动
        this.gridOffset = (this.gridOffset + 2) % 40;

        // 1. 生成子弹
        if (this.frame % Math.floor(this.player.rate) === 0) {
            const cnt = this.player.bullets;
            for (let i=0; i<cnt; i++) {
                const angle = (i - (cnt-1)/2) * 0.1;
                this.objs.bullets.push({
                    x: this.player.x, y: this.player.y - 20,
                    vx: Math.sin(angle)*4, vy: -14,
                    dmg: this.player.dmg,
                    color: this.player.dmg > 30 ? '#0ff' : '#ff0' // 伤害高变色
                });
            }
        }

        // 2. 生成敌人 (难度曲线优化)
        const spawnRate = Math.max(25, 70 - this.level * 4);
        if (this.frame % spawnRate === 0) {
            this.spawnEnemy();
        }

        // 3. 实体运动与碰撞
        this.updateEntities();
    }

    spawnEnemy() {
        const r = Math.random();
        let type = 0; // 0:Basic, 1:Speed, 2:Tank
        if (this.level > 1 && r < 0.3) type = 1;
        if (this.level > 3 && r < 0.1) type = 2;
        
        const conf = [
            { hp: 15, spd: 2, score: 10, col: '#f05' }, // Basic
            { hp: 10, spd: 4, score: 20, col: '#ff0' }, // Speed
            { hp: 80, spd: 1, score: 50, col: '#b0f' }  // Tank
        ];
        
        // 难度系数：每关敌人血量 +20%
        const hpMult = 1 + (this.level - 1) * 0.2;
        // 速度系数：第一关特别慢，后面正常
        const spdMult = this.level === 1 ? 0.7 : (1 + (this.level * 0.05));

        this.objs.enemies.push({
            x: Math.random() * (this.w - 40) + 20,
            y: -50,
            hp: conf[type].hp * hpMult, maxHp: conf[type].hp * hpMult,
            spd: conf[type].spd * spdMult,
            score: conf[type].score,
            color: conf[type].col,
            r: type === 2 ? 25 : 15,
            type: type
        });
    }

    updateEntities() {
        // 子弹
        this.objs.bullets = this.objs.bullets.filter(b => {
            b.x += b.vx; b.y += b.vy;
            return b.y > -20 && b.x > 0 && b.x < this.w;
        });

        // 粒子
        this.objs.particles = this.objs.particles.filter(p => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.04;
            return p.life > 0;
        });
        
        // 飘字
        this.objs.texts = this.objs.texts.filter(t => {
            t.y -= 1.5; t.life -= 0.02;
            return t.life > 0;
        });

        // 敌人
        this.objs.enemies.forEach((e, i) => {
            e.y += e.spd;

            // 撞击玩家
            if (Math.hypot(e.x - this.player.x, e.y - this.player.y) < e.r + 20) {
                this.player.hp -= 25;
                this.explode(e.x, e.y, e.color, 15);
                e.dead = true;
                this.checkGameOver();
                this.updateUI();
            }

            // 被子弹击中
            this.objs.bullets.forEach((b, j) => {
                if (Math.hypot(b.x - e.x, b.y - e.y) < e.r + 10) {
                    e.hp -= b.dmg;
                    b.dead = true; // 标记子弹删除
                    this.spawnParticle(b.x, b.y, '#fff', 1);
                    
                    if (e.hp <= 0 && !e.dead) {
                        e.dead = true;
                        this.killEnemy(e);
                    }
                }
            });
        });

        // 清理死亡实体
        this.objs.bullets = this.objs.bullets.filter(b => !b.dead);
        this.objs.enemies = this.objs.enemies.filter(e => !e.dead && e.y < this.h);
    }

    killEnemy(e) {
        this.explode(e.x, e.y, e.color, 10);
        this.score += e.score;
        
        // 奖励增加：1.5倍金币掉落
        const coins = Math.ceil(e.score * 0.8);
        this.coins += coins;
        this.addText(`+${coins}`, e.x, e.y, '#ff0');
        
        this.levelProgress++;
        if (this.levelProgress >= this.levelGoal) {
            this.state = 'SHOP';
            setTimeout(() => {
                document.getElementById('shopScreen').classList.remove('hidden');
                this.updateShop();
            }, 500);
        }
        this.updateUI();
    }

    checkGameOver() {
        if (this.player.hp <= 0) {
            this.state = 'OVER';
            document.getElementById('finalScore').innerText = this.score;
            document.getElementById('overScreen').classList.remove('hidden');
        }
    }

    // --- 商店升级 ---

    upgrade(type) {
        const p = this.prices[type];
        if (type === 'heal') {
            if (this.coins >= 50) {
                this.coins -= 50;
                this.player.hp = this.player.maxHp;
            }
        } else if (this.coins >= p) {
            this.coins -= p;
            this.prices[type] = Math.floor(p * 1.5);
            if (type === 'dmg') this.player.dmg *= 1.25;
            if (type === 'rate') this.player.rate *= 0.85;
            if (type === 'multi') this.player.bullets++;
        }
        this.updateShop();
        this.updateUI();
    }

    updateShop() {
        document.getElementById('shopCoins').innerText = this.coins;
        ['dmg', 'rate', 'multi'].forEach(k => {
            document.getElementById(`p-${k}`).innerText = this.prices[k];
            const btn = document.getElementById(`btn-${k}`);
            if (this.coins < this.prices[k]) btn.classList.add('disabled');
            else btn.classList.remove('disabled');
        });
        
        const healBtn = document.getElementById('btn-heal');
        healBtn.classList.toggle('disabled', this.coins < 50 || this.player.hp >= this.player.maxHp);
    }

    // --- 视觉特效 ---

    explode(x, y, color, count) {
        // 屏幕震动
        this.container.style.transform = `translate(${Math.random()*4-2}px, ${Math.random()*4-2}px)`;
        setTimeout(() => this.container.style.transform = 'none', 50);
        
        for(let i=0; i<count; i++) {
            const a = Math.random() * 6.28;
            const s = Math.random() * 5;
            this.objs.particles.push({
                x, y, vx: Math.cos(a)*s, vy: Math.sin(a)*s,
                life: 1, color: color, sz: Math.random()*3
            });
        }
    }

    spawnParticle(x, y, col, sz) {
        this.objs.particles.push({x, y, vx:(Math.random()-0.5)*2, vy:(Math.random()-0.5)*2, life:0.5, color:col, sz:sz});
    }

    addText(str, x, y, col) {
        this.objs.texts.push({str, x, y, color:col, life:1});
    }

    draw() {
        // 背景清理与绘制
        this.ctx.fillStyle = '#050b14';
        this.ctx.fillRect(0, 0, this.w, this.h);

        // 1. 绘制复古网格
        this.ctx.strokeStyle = 'rgba(0, 243, 255, 0.15)';
        this.ctx.lineWidth = 1;
        this.ctx.beginPath();
        // 横线
        for(let i = this.gridOffset; i < this.h; i+=40) {
            this.ctx.moveTo(0, i); this.ctx.lineTo(this.w, i);
        }
        // 竖线 (透视效果简化)
        for(let i = 0; i <= this.w; i+=40) {
            this.ctx.moveTo(i, 0); this.ctx.lineTo(i, this.h);
        }
        this.ctx.stroke();

        // 2. 星星
        this.ctx.fillStyle = '#fff';
        this.stars.forEach(s => {
            s.y += s.z * (this.level > 5 ? 2 : 0.5);
            if (s.y > this.h) { s.y = 0; s.x = Math.random() * this.w; }
            this.ctx.globalAlpha = s.alpha;
            this.ctx.beginPath(); this.ctx.arc(s.x, s.y, s.z, 0, 6.28); this.ctx.fill();
        });
        this.ctx.globalAlpha = 1;

        // 3. 绘制子弹
        this.objs.bullets.forEach(b => {
            this.ctx.shadowBlur = 10; this.ctx.shadowColor = b.color;
            this.ctx.fillStyle = b.color;
            this.ctx.beginPath(); 
            this.ctx.arc(b.x, b.y, 4, 0, 6.28); 
            this.ctx.fill();
        });
        this.ctx.shadowBlur = 0;

        // 4. 绘制敌人
        this.objs.enemies.forEach(e => {
            this.ctx.save();
            this.ctx.translate(e.x, e.y);
            this.ctx.fillStyle = e.color;
            this.ctx.shadowBlur = 15; this.ctx.shadowColor = e.color;
            
            // 简单的呼吸效果
            const scale = 1 + Math.sin(this.frame * 0.1) * 0.1;
            this.ctx.scale(scale, scale);

            if (e.type === 2) { // Tank
                 this.ctx.fillRect(-20, -20, 40, 40);
            } else { // Triangle
                this.ctx.beginPath();
                this.ctx.moveTo(0, 15);
                this.ctx.lineTo(15, -15);
                this.ctx.lineTo(-15, -15);
                this.ctx.fill();
            }
            this.ctx.restore();
            
            // 血条
            this.ctx.fillStyle = '#0f0';
            this.ctx.fillRect(e.x-15, e.y-e.r-10, 30 * (e.hp/e.maxHp), 3);
        });

        // 5. 绘制玩家
        this.drawPlayer();

        // 6. 粒子与文字
        this.objs.particles.forEach(p => {
            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.sz, 0, 6.28); this.ctx.fill();
        });
        
        this.ctx.font = "bold 20px Orbitron";
        this.objs.texts.forEach(t => {
            this.ctx.globalAlpha = t.life;
            this.ctx.fillStyle = t.color;
            this.ctx.fillText(t.str, t.x - 10, t.y);
        });
        this.ctx.globalAlpha = 1;
    }

    drawPlayer() {
        const {x, y, skin} = this.player;
        this.ctx.save();
        this.ctx.translate(x, y);
        
        // 尾焰
        this.ctx.shadowBlur = 20; this.ctx.shadowColor = '#0ff';
        this.ctx.fillStyle = `rgba(0, 243, 255, ${Math.random()})`;
        this.ctx.beginPath();
        this.ctx.moveTo(-5, 15); this.ctx.lineTo(0, 35 + Math.random()*10); this.ctx.lineTo(5, 15);
        this.ctx.fill();

        // 战机主体
        this.ctx.fillStyle = '#fff';
        if (skin === 0) {
            // 基础
            this.ctx.beginPath(); this.ctx.moveTo(0,-25); this.ctx.lineTo(18,15); this.ctx.lineTo(0,10); this.ctx.lineTo(-18,15); this.ctx.fill();
        } else if (skin === 1) {
            // 进阶 (紫色)
            this.ctx.shadowColor = '#bc13fe'; this.ctx.fillStyle = '#bc13fe';
            this.ctx.beginPath(); this.ctx.moveTo(0,-30); this.ctx.lineTo(10,20); this.ctx.lineTo(0,15); this.ctx.lineTo(-10,20); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.moveTo(0,0); this.ctx.lineTo(25,10); this.ctx.lineTo(25,25); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.moveTo(0,0); this.ctx.lineTo(-25,10); this.ctx.lineTo(-25,25); this.ctx.fill();
        } else {
            // 黄金神
            this.ctx.shadowColor = '#ffe600'; this.ctx.fillStyle = '#ffe600';
            this.ctx.beginPath(); this.ctx.moveTo(0,-35); this.ctx.lineTo(8,20); this.ctx.lineTo(-8,20); this.ctx.fill();
            this.ctx.fillStyle = '#ffaa00';
            this.ctx.beginPath(); this.ctx.moveTo(10,-10); this.ctx.lineTo(25,20); this.ctx.lineTo(5,15); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.moveTo(-10,-10); this.ctx.lineTo(-25,20); this.ctx.lineTo(-5,15); this.ctx.fill();
        }
        this.ctx.restore();
    }

    updateUI() {
        document.getElementById('uiScore').innerText = this.score.toString().padStart(4, '0');
        document.getElementById('uiLevel').innerText = this.level;
        document.getElementById('uiCoins').innerText = this.coins;
        document.getElementById('uiHp').style.width = (this.player.hp / this.player.maxHp * 100) + "%";
    }

    loop() {
        if(this.state === 'PLAY') {
            this.frame++;
            this.update();
            this.draw();
        }
        requestAnimationFrame(this.loop);
    }
}

const game = new Game();
</script>
</body>
</html>