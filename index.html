<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜Ÿé™…æˆ˜æœº: æé€Ÿé¢†åŸŸ (éŸ³æ•ˆç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒæ ·å¼ --- */
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-red: #ff0055;
            --neon-green: #00ff99;
            --bg-dark: #050b14;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; }
        
        body { 
            background: #000; height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            font-family: 'Orbitron', sans-serif; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000 100%);
        }

        #gameContainer {
            position: relative; width: 100%; max-width: 480px; height: 100%; max-height: 920px;
            background: var(--bg-dark); box-shadow: 0 0 60px rgba(0, 243, 255, 0.15); overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI å±‚ --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }

        .hud-top { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .score-box { text-shadow: 0 0 5px var(--neon-blue); text-align: right; }
        .score-val { font-size: 24px; font-weight: 700; color: #fff; }
        
        /* é¡¶éƒ¨æŒ‰é’®ç»„ */
        .top-btns { display: flex; gap: 10px; }
        .icon-btn {
            width: 40px; height: 40px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 16px; background: rgba(0,0,0,0.5);
            cursor: pointer; touch-action: manipulation;
        }
        .icon-btn:active { transform: scale(0.9); background: var(--neon-blue); }

        /* åº•éƒ¨ HUD */
        .hud-bottom { margin-bottom: 10px; }
        .coin-display { font-size: 18px; color: #ffd700; margin-bottom: 5px; text-shadow: 0 0 5px #ffd700; }
        
        .hp-container {
            position: relative; width: 100%; height: 16px;
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; overflow: hidden;
        }
        .hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff3333, #ff0055); transition: width 0.2s; }
        .hp-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px #000; z-index: 2;
        }

        /* --- å¼¹çª— --- */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 10, 0.9); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; opacity: 1; transition: opacity 0.3s; pointer-events: auto;
        }
        .hidden { opacity: 0; pointer-events: none !important; }

        .title { font-size: 40px; font-weight: 900; color: transparent; -webkit-text-stroke: 1px var(--neon-blue); margin-bottom: 10px; text-align: center; }
        .high-score { color: var(--neon-purple); font-size: 14px; margin-bottom: 30px; }

        .c-btn {
            background: transparent; color: var(--neon-blue);
            border: 2px solid var(--neon-blue); padding: 12px 40px;
            font-family: 'Orbitron'; font-size: 18px; font-weight: bold;
            cursor: pointer; margin: 10px; transition: 0.3s; touch-action: manipulation;
        }
        .c-btn:active { background: var(--neon-blue); color: #000; transform: scale(0.95); }
        .c-btn.red { border-color: var(--neon-red); color: var(--neon-red); }
        .c-btn.red:active { background: var(--neon-red); color: #fff; }

        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; margin-bottom: 20px; }
        .card {
            background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 10px;
            text-align: center; border-radius: 5px; cursor: pointer; touch-action: manipulation;
        }
        .card:active { background: rgba(0, 243, 255, 0.2); border-color: var(--neon-blue); transform: scale(0.98); }
        .card.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>

    <!-- æˆ˜æ–— UI -->
    <div id="hud" class="ui-layer hidden">
        <div class="hud-top">
            <div class="top-btns">
                <div class="icon-btn" id="btnPause">||</div>
                <div class="icon-btn" id="btnMute">ğŸ”Š</div>
            </div>
            <div class="score-box">
                <div style="font-size:12px; color:#8899ac">SCORE</div>
                <div class="score-val" id="uiScore">0</div>
            </div>
        </div>
        <div class="hud-bottom">
            <div class="coin-display">âš¡ <span id="uiCoins">0</span></div>
            <div class="hp-container">
                <div class="hp-bar" id="uiHp"></div>
                <div class="hp-text" id="uiHpText">HP: 100/100</div>
            </div>
        </div>
    </div>

    <!-- å¼€å§‹èœå• -->
    <div id="startScreen" class="modal">
        <h1 class="title" style="-webkit-text-stroke:0; color:white; text-shadow:0 0 20px var(--neon-blue)">CYBER<br>WING</h1>
        <div class="high-score">BEST: <span id="menuBestScore">0</span></div>
        <p style="color:#aaa; font-size:12px; margin-bottom:20px">(ç‚¹å‡»å¼€å§‹ä»¥æ¿€æ´»éŸ³æ•ˆ)</p>
        <button class="c-btn" id="btnStart">START MISSION</button>
    </div>

    <!-- æš‚åœèœå• -->
    <div id="pauseMenu" class="modal hidden">
        <h2 style="color:white; margin-bottom:30px;">PAUSED</h2>
        <button class="c-btn" id="btnResume">RESUME</button>
        <button class="c-btn red" id="btnQuit">EXIT</button>
    </div>

    <!-- å•†åº— -->
    <div id="shopScreen" class="modal hidden">
        <h2 style="color:var(--neon-green);">WAVE COMPLETE</h2>
        <p style="color:#aaa; margin-bottom:20px">CREDITS: <span id="shopCoins" style="color:#ffd700">0</span></p>
        <div class="shop-grid">
            <div class="card" id="btn-dmg">
                <div style="color:var(--neon-blue); font-weight:bold">ç«åŠ›æå‡</div>
                <div style="font-size:12px; color:#888">ä¼¤å®³ +20%</div>
                <div style="color:#ffd700">âš¡ <span id="p-dmg">100</span></div>
            </div>
            <div class="card" id="btn-rate">
                <div style="color:var(--neon-red); font-weight:bold">å†·å´åŠ é€Ÿ</div>
                <div style="font-size:12px; color:#888">å°„é€Ÿ +15%</div>
                <div style="color:#ffd700">âš¡ <span id="p-rate">150</span></div>
            </div>
            <div class="card" id="btn-multi">
                <div style="color:var(--neon-purple); font-weight:bold">æ‰©å®¹å¼¹èˆ±</div>
                <div style="font-size:12px; color:#888">å¼¹é“ +1</div>
                <div style="color:#ffd700">âš¡ <span id="p-multi">500</span></div>
            </div>
            <div class="card" id="btn-heal">
                <div style="color:var(--neon-green); font-weight:bold">æœºä½“ç»´ä¿®</div>
                <div style="font-size:12px; color:#888">HP å›æ»¡</div>
                <div style="color:#ffd700">âš¡ 50</div>
            </div>
        </div>
        <button class="c-btn" id="btnNext">NEXT WAVE >></button>
    </div>

    <!-- ç»“ç®— -->
    <div id="overScreen" class="modal hidden">
        <h1 style="color:var(--neon-red);">FAILURE</h1>
        <h2 style="color:white;">SCORE: <span id="endScore">0</span></h2>
        <button class="c-btn" id="btnRetry">RETRY</button>
        <button class="c-btn red" id="btnMenu">MENU</button>
    </div>
</div>

<script>
/**
 * éŸ³é¢‘å¼•æ“ - ä½¿ç”¨ Web Audio API å®æ—¶åˆæˆéŸ³æ•ˆ
 * ä¸éœ€è¦å¤–éƒ¨æ–‡ä»¶ï¼Œçº¯ä»£ç ç”Ÿæˆ
 */
class SoundManager {
    constructor() {
        this.ctx = null;
        this.muted = false;
        this.bgmOsc = null;
        this.bgmGain = null;
    }

    init() {
        if (!this.ctx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
    }

    toggleMute() {
        this.muted = !this.muted;
        if (this.muted) {
            if(this.bgmGain) this.bgmGain.gain.value = 0;
        } else {
            if(this.bgmGain) this.bgmGain.gain.value = 0.15;
        }
        return this.muted;
    }

    // æ’­æ”¾éŸ³æ•ˆ
    play(type) {
        if (this.muted || !this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);

        switch (type) {
            case 'shoot': // æ¿€å…‰
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, t);
                osc.frequency.exponentialRampToValueAtTime(100, t + 0.1);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t);
                osc.stop(t + 0.1);
                break;

            case 'explode': // çˆ†ç‚¸ (æ¨¡æ‹Ÿå™ªå£°)
                // å™ªå£°éœ€è¦ bufferSource
                const bufferSize = this.ctx.sampleRate * 0.5; // 0.5 sec
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const noiseGain = this.ctx.createGain();
                noise.connect(noiseGain);
                noiseGain.connect(this.ctx.destination);
                
                noiseGain.gain.setValueAtTime(0.3, t);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                noise.start(t);
                break;

            case 'coin': // é‡‘å¸
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, t);
                osc.frequency.setValueAtTime(1600, t + 0.05);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                osc.start(t);
                osc.stop(t + 0.3);
                break;

            case 'powerup': // å‡çº§/è´­ä¹°
                osc.type = 'square';
                osc.frequency.setValueAtTime(220, t);
                osc.frequency.linearRampToValueAtTime(880, t + 0.2);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.start(t);
                osc.stop(t + 0.3);
                break;
            
            case 'hit': // è¢«å‡»ä¸­
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.linearRampToValueAtTime(50, t + 0.2);
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.2);
                osc.start(t);
                osc.stop(t + 0.2);
                break;
        }
    }

    // å¯åŠ¨èƒŒæ™¯æ°›å›´éŸ³ (Drone)
    startBGM() {
        if (!this.ctx || this.bgmOsc) return;
        this.bgmOsc = this.ctx.createOscillator();
        this.bgmGain = this.ctx.createGain();
        
        // ä½é¢‘éœ‡è¡ Sawtooth
        this.bgmOsc.type = 'sawtooth';
        this.bgmOsc.frequency.value = 50; // 50Hz ä½éŸ³
        
        // LFO åˆ¶é€ æ³¢åŠ¨æ„Ÿ
        const lfo = this.ctx.createOscillator();
        lfo.type = 'sine';
        lfo.frequency.value = 0.5; // 0.5Hz æ³¢åŠ¨
        const lfoGain = this.ctx.createGain();
        lfoGain.gain.value = 500; // Filter å˜åŠ¨å¹…åº¦
        
        // ä½é€šæ»¤æ³¢å™¨
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 800; 

        // è¿æ¥: LFO -> LFO Gain -> Filter Frequency
        lfo.connect(lfoGain);
        lfoGain.connect(filter.frequency);

        // è¿æ¥: Osc -> Filter -> Gain -> Dest
        this.bgmOsc.connect(filter);
        filter.connect(this.bgmGain);
        this.bgmGain.connect(this.ctx.destination);

        this.bgmGain.gain.value = this.muted ? 0 : 0.15;
        
        this.bgmOsc.start();
        lfo.start();
    }

    stopBGM() {
        if(this.bgmOsc) {
            // ç®€å•åœ°å°†éŸ³é‡è®¾ä¸º0ï¼Œä¿æŒå¯¹è±¡å­˜æ´»ä»¥ä¾¿å¤ç”¨å¤ªéº»çƒ¦ï¼Œç›´æ¥åœæ­¢
            // åœ¨è¿™ä¸ªç®€å•ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¾èµ– gain = 0 æ¥é™éŸ³ï¼Œå½»åº•åœæ­¢ç­‰æ¸¸æˆç»“æŸ
            if(this.bgmGain) this.bgmGain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.5);
            setTimeout(() => {
                if(this.bgmOsc) { this.bgmOsc.stop(); this.bgmOsc = null; }
            }, 600);
        }
    }
}

class Game {
    constructor() {
        this.c = document.getElementById('gameCanvas');
        this.ctx = this.c.getContext('2d');
        this.container = document.getElementById('gameContainer');
        
        this.resize();
        window.addEventListener('resize', () => this.resize());

        this.sound = new SoundManager(); // å®ä¾‹åŒ–éŸ³æ•ˆç®¡ç†å™¨

        this.highScore = 0;
        try { this.highScore = parseInt(localStorage.getItem('cyber_wing_hs')) || 0; } catch(e) {}
        document.getElementById('menuBestScore').innerText = this.highScore;

        this.state = 'MENU';
        this.frame = 0;
        this.loopId = null;
        this.stars = Array(50).fill().map(() => this.createStar());
        
        this.bindEvents();
        this.bgLoop();
    }

    resize() {
        this.w = this.container.clientWidth || window.innerWidth;
        this.h = this.container.clientHeight || window.innerHeight;
        this.c.width = this.w;
        this.c.height = this.h;
    }

    createStar() {
        return {x: Math.random()*this.w, y: Math.random()*this.h, s: Math.random()*2, v: Math.random()+0.5};
    }

    bindEvents() {
        const moveHandler = (x, y) => {
            if (this.state === 'PLAY') {
                const rect = this.c.getBoundingClientRect();
                this.player.x = x - rect.left;
                this.player.y = Math.max(this.h/2, Math.min(this.h-50, y - rect.top - 50));
            }
        };
        this.c.addEventListener('mousemove', e => moveHandler(e.clientX, e.clientY));
        this.c.addEventListener('touchmove', e => {
            e.preventDefault();
            if(e.touches.length > 0) moveHandler(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive:false});

        const click = (id, fn) => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('click', fn);
                el.addEventListener('touchstart', (e) => { e.stopPropagation(); fn(); }, {passive: true});
            }
        };
        click('btnStart', () => this.start());
        click('btnPause', () => this.pause());
        click('btnResume', () => this.resume());
        click('btnQuit', () => this.quit());
        click('btnRetry', () => this.restart());
        click('btnMenu', () => this.quit());
        click('btnNext', () => this.nextWave());
        click('btn-dmg', () => this.buy('dmg'));
        click('btn-rate', () => this.buy('rate'));
        click('btn-multi', () => this.buy('multi'));
        click('btn-heal', () => this.buy('heal'));
        
        // é™éŸ³æŒ‰é’®é€»è¾‘
        click('btnMute', () => {
            const isMuted = this.sound.toggleMute();
            document.getElementById('btnMute').innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        });
    }

    start() {
        this.sound.init(); // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        this.sound.startBGM(); // å¯åŠ¨èƒŒæ™¯éŸ³
        
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        this.reset();
        this.state = 'PLAY';
        this.run();
    }

    pause() {
        if (this.state === 'PLAY') {
            this.state = 'PAUSE';
            document.getElementById('pauseMenu').classList.remove('hidden');
            cancelAnimationFrame(this.loopId);
        }
    }

    resume() {
        if (this.state === 'PAUSE') {
            this.state = 'PLAY';
            document.getElementById('pauseMenu').classList.add('hidden');
            this.run();
        }
    }

    quit() {
        this.sound.stopBGM();
        this.state = 'MENU';
        document.querySelectorAll('.modal').forEach(el => el.classList.add('hidden'));
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
        document.getElementById('menuBestScore').innerText = this.highScore;
        cancelAnimationFrame(this.loopId);
        this.bgLoop();
    }

    reset() {
        this.player = {
            x: this.w/2, y: this.h-100, r: 15,
            hp: 100, maxHp: 100,
            dmg: 20, rate: 20, bullets: 1,
            buffTime: 0
        };
        this.score = 0;
        this.coins = 0;
        this.wave = 1;
        this.waveProgress = 0;
        this.waveGoal = 15;
        this.prices = { dmg: 100, rate: 150, multi: 500 };
        this.entities = { pBullets: [], eBullets: [], enemies: [], particles: [], texts: [], items: [] };
        this.updateUI();
    }

    restart() {
        document.getElementById('overScreen').classList.add('hidden');
        this.sound.startBGM();
        this.reset();
        this.state = 'PLAY';
        this.run();
    }

    nextWave() {
        document.getElementById('shopScreen').classList.add('hidden');
        this.wave++;
        this.waveProgress = 0;
        this.waveGoal = 15 + this.wave * 8;
        this.entities.pBullets = [];
        this.entities.eBullets = [];
        this.entities.items = [];
        this.state = 'PLAY';
        this.run();
    }

    run() {
        if (this.state !== 'PLAY') return;
        this.frame++;
        this.update();
        this.draw();
        this.loopId = requestAnimationFrame(() => this.run());
    }

    update() {
        // ç©å®¶å°„å‡»
        if (this.frame % Math.floor(this.player.rate) === 0) {
            this.sound.play('shoot'); // æ’­æ”¾å°„å‡»éŸ³æ•ˆ
            const cnt = this.player.bullets;
            const isBuffed = this.player.buffTime > 0;
            if(isBuffed) this.player.buffTime--;
            for(let i=0; i<cnt; i++) {
                const angle = (i - (cnt-1)/2) * 0.15;
                this.entities.pBullets.push({
                    x: this.player.x, y: this.player.y-20,
                    vx: Math.sin(angle)*5, vy: -15,
                    dmg: this.player.dmg * (isBuffed ? 2 : 1),
                    isBuffed: isBuffed
                });
            }
        }

        const spawnRate = Math.max(10, 55 - this.wave * 4); 
        if (this.frame % spawnRate === 0) this.spawnEnemy();

        this.updateEntities();
    }

    spawnEnemy() {
        const r = Math.random();
        let type = 0; 
        if (this.wave > 1 && r < 0.3 + (this.wave*0.02)) type = 1;
        if (this.wave > 2 && r < 0.15 + (this.wave*0.02)) type = 2;
        if (this.wave > 3 && r < 0.1 + (this.wave*0.02)) type = 3;

        const hpScale = 1 + (this.wave * 0.25);
        const stats = [
            { hp: 20, spd: 3, col: '#ff0055', score: 10, r:15, dmg: 15 }, 
            { hp: 10, spd: 5, col: '#ffff00', score: 20, r:12, dmg: 10 }, 
            { hp: 100, spd: 1, col: '#bc13fe', score: 50, r:25, dmg: 40 }, 
            { hp: 40, spd: 2, col: '#fff', score: 30, r:18, dmg: 15 }
        ];

        const cfg = stats[type];
        this.entities.enemies.push({
            x: Math.random()*(this.w-40)+20, y: -40,
            hp: cfg.hp * hpScale, maxHp: cfg.hp * hpScale,
            spd: cfg.spd, score: cfg.score, color: cfg.col, r: cfg.r,
            dmg: cfg.dmg, type: type, lastShot: 0
        });
    }

    updateEntities() {
        const { pBullets, eBullets, enemies, items } = this.entities;
        const p = this.player;

        for (let i = pBullets.length-1; i>=0; i--) {
            let b = pBullets[i];
            b.x += b.vx; b.y += b.vy;
            if (b.y < -20) pBullets.splice(i, 1);
        }
        
        for (let i = eBullets.length-1; i>=0; i--) {
            let b = eBullets[i];
            b.x += b.vx; b.y += b.vy;
            if (Math.hypot(b.x - p.x, b.y - p.y) < p.r + 5) {
                this.takeDamage(b.dmg); 
                this.explode(p.x, p.y, '#f00', 5);
                eBullets.splice(i, 1);
            } else if (b.y > this.h || b.y < -50 || b.x < -50 || b.x > this.w + 50) {
                eBullets.splice(i, 1);
            }
        }

        for (let i = items.length-1; i>=0; i--) {
            let it = items[i];
            it.y += 2;
            if (Math.hypot(it.x - p.x, it.y - p.y) < p.r + 15) {
                this.sound.play('coin'); // æ’­æ”¾é‡‘å¸éŸ³æ•ˆ
                this.applyItem(it.type);
                this.addText(it.label, p.x, p.y-30, '#fff');
                items.splice(i, 1);
            } else if (it.y > this.h) items.splice(i, 1);
        }

        for (let i = enemies.length-1; i>=0; i--) {
            let e = enemies[i];
            e.y += e.spd;

            if (e.type === 3 && this.frame - e.lastShot > 100) {
                e.lastShot = this.frame;
                let angle = Math.atan2(p.y - e.y, p.x - e.x);
                eBullets.push({x: e.x, y: e.y, vx: Math.cos(angle)*6, vy: Math.sin(angle)*6, dmg: 15});
            }

            if (Math.hypot(e.x - p.x, e.y - p.y) < e.r + p.r) {
                this.takeDamage(e.dmg);
                e.hp = 0;
                this.sound.play('explode'); // æ’å‡»çˆ†ç‚¸
                this.explode(e.x, e.y, e.color, 10);
            }

            for (let j = pBullets.length-1; j>=0; j--) {
                let b = pBullets[j];
                if (Math.hypot(b.x - e.x, b.y - e.y) < e.r + 10) {
                    e.hp -= b.dmg;
                    pBullets.splice(j, 1);
                    this.spawnParticle(b.x, b.y, '#fff', 1);
                    if (e.hp <= 0) {
                        this.sound.play('explode'); // æ•Œäººæ­»äº¡çˆ†ç‚¸
                        this.score += e.score;
                        this.coins += Math.ceil(e.score/2);
                        this.explode(e.x, e.y, e.color, 12);
                        this.addText(`+${Math.ceil(e.score/2)}`, e.x, e.y, '#ffd700');
                        if (Math.random() < 0.15) this.dropItem(e.x, e.y);
                        enemies.splice(i, 1);
                        this.checkWave();
                        this.updateUI();
                        break;
                    }
                }
            }
            if (e.y > this.h && e.hp > 0) enemies.splice(i, 1);
            if (e.hp <= 0 && enemies.includes(e)) { enemies.splice(i, 1); this.checkWave(); this.updateUI(); }
        }

        this.entities.particles = this.entities.particles.filter(p => { p.x+=p.vx; p.y+=p.vy; p.life-=0.05; return p.life>0; });
        this.entities.texts = this.entities.texts.filter(t => { t.y-=1; t.life-=0.02; return t.life>0; });
    }

    takeDamage(amount) {
        this.sound.play('hit'); // æ’­æ”¾å—ä¼¤éŸ³æ•ˆ
        this.player.hp -= amount;
        this.addText(`-${amount}`, this.player.x, this.player.y - 30, '#ff0055');
        this.checkOver();
        this.updateUI();
    }

    dropItem(x, y) {
        const r = Math.random();
        let type, color, label;
        if (r < 0.4) { type='heal'; color='#0f0'; label='HP+'; }
        else if (r < 0.8) { type='power'; color='#f00'; label='DMG UP'; }
        else { type='coin'; color='#ffd700'; label='COINS'; }
        this.entities.items.push({x, y, type, color, label});
    }

    applyItem(type) {
        if (type === 'heal') this.player.hp = Math.min(this.player.hp + 30, this.player.maxHp);
        else if (type === 'power') this.player.buffTime = 300;
        else if (type === 'coin') this.coins += 100;
        this.updateUI();
    }

    checkOver() {
        if (this.player.hp <= 0) {
            this.sound.stopBGM();
            this.state = 'OVER';
            try {
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('cyber_wing_hs', this.highScore);
                }
            } catch(e){}
            document.getElementById('endScore').innerText = this.score;
            document.getElementById('overScreen').classList.remove('hidden');
            cancelAnimationFrame(this.loopId);
        }
    }

    checkWave() {
        this.waveProgress++;
        if (this.waveProgress >= this.waveGoal) {
            this.state = 'SHOP';
            cancelAnimationFrame(this.loopId);
            this.updateShop();
            document.getElementById('shopScreen').classList.remove('hidden');
        }
    }

    buy(type) {
        const p = this.prices[type];
        if (type === 'heal') {
            if (this.coins >= 50) { 
                this.coins -= 50; this.player.hp = this.player.maxHp; 
                this.sound.play('powerup');
            }
        } else if (this.coins >= p) {
            this.coins -= p;
            this.prices[type] = Math.floor(p * 1.5);
            if (type === 'dmg') this.player.dmg *= 1.2;
            if (type === 'rate') this.player.rate = Math.max(5, this.player.rate * 0.9);
            if (type === 'multi') this.player.bullets++;
            this.sound.play('powerup');
        }
        this.updateShop();
        this.updateUI();
    }

    updateShop() {
        document.getElementById('shopCoins').innerText = this.coins;
        ['dmg', 'rate', 'multi'].forEach(k => {
            document.getElementById('p-'+k).innerText = this.prices[k];
            const el = document.getElementById('btn-'+k);
            if(this.coins < this.prices[k]) el.classList.add('disabled');
            else el.classList.remove('disabled');
        });
    }

    draw() {
        this.ctx.fillStyle = '#050b14'; this.ctx.fillRect(0,0,this.w,this.h);
        
        this.ctx.fillStyle = '#fff';
        this.stars.forEach(s => {
            s.y += s.v; if(s.y>this.h) s.y=0;
            this.ctx.globalAlpha = Math.random()*0.5+0.3;
            this.ctx.beginPath(); this.ctx.arc(s.x,s.y,s.s,0,6.28); this.ctx.fill();
        });
        this.ctx.globalAlpha = 1;

        this.entities.items.forEach(it => {
            this.ctx.shadowBlur = 15; this.ctx.shadowColor = it.color;
            this.ctx.fillStyle = it.color;
            this.ctx.beginPath(); this.ctx.arc(it.x, it.y, 8, 0, 6.28); this.ctx.fill();
            this.ctx.fillStyle = '#000'; this.ctx.font = 'bold 10px Arial'; this.ctx.fillText(it.type[0].toUpperCase(), it.x-3, it.y+3);
        });

        this.entities.pBullets.forEach(b => {
            this.ctx.shadowBlur = 10; this.ctx.shadowColor = b.isBuffed ? '#ff0055' : '#00f3ff';
            this.ctx.fillStyle = b.isBuffed ? '#ff0055' : '#00f3ff';
            this.ctx.beginPath(); this.ctx.arc(b.x, b.y, b.isBuffed?5:3, 0, 6.28); this.ctx.fill();
        });
        
        this.entities.eBullets.forEach(b => {
            this.ctx.shadowBlur = 10; this.ctx.shadowColor = '#f00';
            this.ctx.fillStyle = '#f00';
            this.ctx.beginPath(); this.ctx.arc(b.x, b.y, 4, 0, 6.28); this.ctx.fill();
        });

        this.entities.enemies.forEach(e => {
            this.ctx.shadowBlur = 10; this.ctx.shadowColor = e.color;
            this.ctx.fillStyle = e.color;
            this.ctx.beginPath();
            if(e.type===2) this.ctx.fillRect(e.x-e.r, e.y-e.r, e.r*2, e.r*2);
            else if(e.type===3) {
                this.ctx.moveTo(e.x, e.y-e.r); this.ctx.lineTo(e.x+e.r, e.y); 
                this.ctx.lineTo(e.x, e.y+e.r); this.ctx.lineTo(e.x-e.r, e.y); this.ctx.fill();
            } else {
                this.ctx.moveTo(e.x, e.y+e.r); this.ctx.lineTo(e.x+e.r, e.y-e.r); 
                this.ctx.lineTo(e.x-e.r, e.y-e.r); this.ctx.fill();
            }
            this.ctx.fillStyle = '#0f0'; this.ctx.fillRect(e.x-15, e.y-e.r-8, 30*(e.hp/e.maxHp), 3);
        });

        this.ctx.shadowBlur = 20;
        this.ctx.shadowColor = this.player.buffTime > 0 ? '#ff0055' : '#00f3ff';
        this.ctx.fillStyle = this.player.buffTime > 0 ? '#ff0055' : '#00f3ff';
        this.ctx.save(); this.ctx.translate(this.player.x, this.player.y);
        this.ctx.beginPath(); this.ctx.moveTo(0,-20); this.ctx.lineTo(15,15); this.ctx.lineTo(0,10); this.ctx.lineTo(-15,15); this.ctx.fill();
        this.ctx.shadowColor = '#ff5500'; this.ctx.fillStyle = `rgba(255,100,0,${Math.random()})`;
        this.ctx.beginPath(); this.ctx.moveTo(-5,15); this.ctx.lineTo(0,30+Math.random()*10); this.ctx.lineTo(5,15); this.ctx.fill();
        this.ctx.restore();

        this.ctx.shadowBlur = 0;
        this.entities.particles.forEach(p => {
            this.ctx.globalAlpha = p.life; this.ctx.fillStyle = p.color;
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 2, 0, 6.28); this.ctx.fill();
        });
        this.ctx.font = 'bold 16px Arial';
        this.entities.texts.forEach(t => {
            this.ctx.globalAlpha = t.life; this.ctx.fillStyle = t.color;
            this.ctx.fillText(t.str, t.x, t.y);
        });
        this.ctx.globalAlpha = 1;
    }
    
    bgLoop() {
        if (this.state === 'MENU') {
            this.ctx.fillStyle = '#050b14'; this.ctx.fillRect(0,0,this.w,this.h);
            this.ctx.fillStyle = '#fff';
            this.stars.forEach(s => {
                s.y += s.v*0.5; if(s.y>this.h) s.y=0;
                this.ctx.globalAlpha = Math.random()*0.3;
                this.ctx.beginPath(); this.ctx.arc(s.x,s.y,s.s,0,6.28); this.ctx.fill();
            });
            requestAnimationFrame(() => this.bgLoop());
        }
    }

    updateUI() {
        document.getElementById('uiScore').innerText = this.score;
        document.getElementById('uiCoins').innerText = this.coins;
        const hpPct = Math.max(0, (this.player.hp/this.player.maxHp)*100);
        document.getElementById('uiHp').style.width = hpPct + "%";
        document.getElementById('uiHpText').innerText = `HP: ${Math.floor(Math.max(0, this.player.hp))} / ${this.player.maxHp}`;
    }

    spawnParticle(x, y, c, n) { for(let i=0; i<n; i++) this.entities.particles.push({x, y, vx:(Math.random()-0.5)*4, vy:(Math.random()-0.5)*4, life:1, color:c}); }
    explode(x, y, c, n) { this.spawnParticle(x, y, c, n); }
    addText(s, x, y, c) { this.entities.texts.push({str:s, x, y, color:c, life:1}); }
}

window.game = new Game();
</script>
</body>
</html>